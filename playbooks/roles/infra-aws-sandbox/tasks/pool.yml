---
- name: Check if account exists in the DB
  vars:
    _data:
      name:
        S: "{{ account_name }}"
  command: >-
    {{ aws_cli }} --profile {{ dynamodb_profile }} --region {{ dynamodb_region }}
    dynamodb get-item
    --table-name {{ dynamodb_table }}
    --key '{{ _data | to_json }}'
  register: _getaccount

- debug:
    var: _getaccount

# Fetch fields to preserve during CREATE/RESET operations
# These are fetched once and reused by both CREATE and RESET blocks
- name: Set account_exists flag
  set_fact:
    account_exists: "{{ 'Item' in (_getaccount.stdout | default('{}') | from_json) }}"

- name: Get preserved fields from existing account
  vars:
    _data:
      name:
        S: "{{ account_name }}"
  command: >-
    {{ aws_cli }} --profile {{ dynamodb_profile | quote }}
    --region {{ dynamodb_region | quote }}
    dynamodb get-item
    --table-name {{ dynamodb_table }}
    --key '{{ _data | to_json }}'
    --query 'Item.{custom_data: custom_data.S, rhsso_username: rhsso_username.S, reservation: reservation.S, external_id: external_id.S}'
    --output json
  register: r_get_preserved
  changed_when: false
  when: account_exists | bool

- name: Parse preserved fields from existing account
  set_fact:
    _preserved: "{{ r_get_preserved.stdout | from_json }}"
  when: account_exists | bool

- name: Initialize preserved fields if account doesn't exist
  set_fact:
    _preserved:
      custom_data: null
      rhsso_username: null
      reservation: null
      external_id: null
  when: not (account_exists | bool)

- name: Build preserved_fields for put-item operations
  set_fact:
    preserved_fields: >-
      {{
        {}
        | combine({'custom_data': {'S': _preserved.custom_data}} if _preserved.custom_data not in [None, '', 'None', 'null'] else {})
        | combine({'rhsso_username': {'S': _preserved.rhsso_username}} if _preserved.rhsso_username not in [None, '', 'None', 'null'] else {})
        | combine({'reservation': {'S': _preserved.reservation}} if _preserved.reservation not in [None, '', 'None', 'null'] else {})
        | combine({'external_id': {'S': _preserved.external_id}} if _preserved.external_id not in [None, '', 'None', 'null'] else {})
      }}

- name: Create account in DB if it doesn't exist
  vars:
    _data:
      name:
        S: "{{ account_name }}"
      available:
        BOOL: "{{ available_after_create }}"
      account_id:
        S: "{{ account_id }}"
      aws_access_key_id:
        S: "{{ account_user_access_key }}"
      aws_secret_access_key:
        S: "{{ account_user_secret_access_key_encrypted }}"
      hosted_zone_id:
        S: "{{ account_hosted_zone_id }}"
      zone:
        S: "{{ account_name }}{{subdomain_base}}"
  command: >-
    {{ aws_cli }} --profile {{ dynamodb_profile }} --region {{ dynamodb_region }}
    dynamodb put-item
    --table-name {{ dynamodb_table }}
    --item '{{ _data | combine(preserved_fields | default({}), recursive=True) | to_json }}'
  register: _putaccount
  when: not (account_exists | bool) or (force_create | default(false) | bool) or (update_stage | default(false) | bool)

- debug:
    var: _putaccount

- when: operation == 'RESET'
  block:
    - name: Pre-Reset account information for validation
      vars:
        _data:
          name:
            S: "{{ account_name }}"
          available:
            BOOL: false
          account_id:
            S: "{{ account_id }}"
          aws_access_key_id:
            S: "{{ account_user_access_key }}"
          aws_secret_access_key:
            S: "{{ account_user_secret_access_key_encrypted }}"
          hosted_zone_id:
            S: "{{ account_hosted_zone_id }}"
          zone:
            S: "{{ account_name }}{{subdomain_base}}"
          comment:
            S: "validation in progress"
      command: >-
        {{ aws_cli }} --profile {{ dynamodb_profile }}
        --region {{ dynamodb_region }}
        dynamodb put-item
        --table-name {{ dynamodb_table }}
        --item '{{ _data | combine(preserved_fields | default({}), recursive=True) | to_json }}'

    - name: Validate Sandbox
      include_tasks: validate.yaml

    - name: Reset account information
      vars:
        _data:
          name:
            S: "{{ account_name }}"
          available:
            BOOL: "{{ available_after_reset }}"
          account_id:
            S: "{{ account_id }}"
          aws_access_key_id:
            S: "{{ account_user_access_key }}"
          aws_secret_access_key:
            S: "{{ account_user_secret_access_key_encrypted }}"
          hosted_zone_id:
            S: "{{ account_hosted_zone_id }}"
          zone:
            S: "{{ account_name }}{{subdomain_base}}"
      command: >-
        {{ aws_cli }} --profile {{ dynamodb_profile }}
        --region {{ dynamodb_region }}
        dynamodb put-item
        --table-name {{ dynamodb_table }}
        --item '{{ _data | combine(preserved_fields | default({}), recursive=True) | to_json }}'
      register: _resetaccount
